---
- name: Garantir regle firewall WinRM (lab, avant durcissement)
  ansible.windows.win_shell: |
    $ruleName = "MegaTP WinRM"
    $existing = Get-NetFirewallRule -DisplayName $ruleName -ErrorAction SilentlyContinue
    if (-not $existing) {
      New-NetFirewallRule -DisplayName $ruleName -Direction Inbound -Action Allow -Protocol TCP -LocalPort 5985,5986 -RemoteAddress 192.168.56.0/24 -Profile Domain,Private,Public | Out-Null
      Write-Output "winrm_rule_created"
    } else {
      Set-NetFirewallRule -DisplayName $ruleName -Enabled True -Profile Domain,Private,Public | Out-Null
      Write-Output "winrm_rule_exists"
    }
  register: winrm_rule
  changed_when: "'winrm_rule_created' in (winrm_rule.stdout | default(''))"

- name: Installer les roles AD DS + DNS + outils AD/GPO
  ansible.windows.win_feature:
    name:
      - AD-Domain-Services
      - DNS
      - RSAT-AD-PowerShell
      - GPMC
    include_management_tools: true
    state: present
  register: ad_features

- name: Redemarrer apres installation des roles (si necessaire)
  ansible.windows.win_reboot:
    reboot_timeout: 7200
  when: ad_features.reboot_required | default(false)

- name: Attendre WinRM apres reboot (roles AD/DNS)
  ansible.builtin.wait_for_connection:
    timeout: 1800
  when: ad_features.reboot_required | default(false)

- name: Verifier si le domaine est deja configure
  ansible.windows.win_shell: |
    try {
      Import-Module ActiveDirectory
      $d = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
      Write-Output "domain_exists:$($d.DNSRoot)"
    } catch {
      Write-Output "domain_missing"
    }
  register: domain_check
  changed_when: false

- name: Creer le domaine (nouvelle foret) si necessaire
  ansible.windows.win_domain:
    dns_domain_name: "{{ domain_name }}"
    domain_netbios_name: "{{ domain_netbios_name }}"
    safe_mode_password: "{{ domain_safe_mode_password }}"
    install_dns: true
    database_path: C:\\Windows\\NTDS
    log_path: C:\\Windows\\NTDS
    sysvol_path: C:\\Windows\\SYSVOL
  register: domain_install
  when: "'domain_missing' in (domain_check.stdout | default(''))"

- name: Redemarrer si necessaire (creation du domaine)
  ansible.windows.win_reboot:
    reboot_timeout: 7200
  when: domain_install.reboot_required | default(false)

- name: Attendre WinRM apres reboot (creation du domaine)
  ansible.builtin.wait_for_connection:
    timeout: 1800
  when: domain_install.reboot_required | default(false)

- name: Attendre que le domaine soit operationnel (cmdlets AD)
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    (Get-ADDomain -Identity "{{ domain_name }}").DNSRoot
  register: ad_ready
  retries: 60
  delay: 10
  until: ad_ready.rc == 0
  changed_when: false

- name: Garantir les droits Schema/Enterprise Admins pour LAPS (lab)
  ansible.windows.win_shell:
    _raw_params: |
      $ErrorActionPreference = "Stop"
      Import-Module ActiveDirectory

      function Ensure-GroupMember {
        param([string]$Group, [string]$MemberSam)
        $present = $false
        try {
          $present = [bool](Get-ADGroupMember -Identity $Group -Recursive -ErrorAction Stop | Where-Object { $_.SamAccountName -eq $MemberSam })
        } catch {
          $present = $false
        }

        if (-not $present) {
          Add-ADGroupMember -Identity $Group -Members $MemberSam -ErrorAction Stop
          Write-Output ("added:{0}:{1}" -f $Group, $MemberSam)
        } else {
          Write-Output ("present:{0}:{1}" -f $Group, $MemberSam)
        }
      }

      $admin = "Administrator"
      Ensure-GroupMember -Group "Schema Admins" -MemberSam $admin
      Ensure-GroupMember -Group "Enterprise Admins" -MemberSam $admin

      # Si Ansible est connecte avec un autre compte (ex: vagrant),
      # on l'ajoute aussi pour eviter "insufficient access rights" sur Update-LapsADSchema.
      $me = $env:USERNAME
      if ($me -and $me -ne $admin) {
        $userObj = Get-ADUser -Identity $me -ErrorAction SilentlyContinue
        if ($null -ne $userObj) {
          Ensure-GroupMember -Group "Schema Admins" -MemberSam $me
          Ensure-GroupMember -Group "Enterprise Admins" -MemberSam $me
        } else {
          Write-Output ("skip_user_not_found:{0}" -f $me)
        }
      }
  register: laps_privs
  changed_when: "'added:' in (laps_privs.stdout | default(''))"

- name: Rafraichir la connexion WinRM (token refresh)
  meta: reset_connection

- name: Etendre le schema AD pour Windows LAPS (auto-retry)
  block:
    - name: Etendre le schema AD pour Windows LAPS (tentative 1)
      ansible.windows.win_shell:
        _raw_params: |
          $ErrorActionPreference = "Stop"
          Import-Module ActiveDirectory

          if (-not (Get-Command Update-LapsADSchema -ErrorAction SilentlyContinue)) {
            throw "Update-LapsADSchema introuvable (module Windows LAPS manquant ?)"
          }

          $schemaNc = (Get-ADRootDSE).schemaNamingContext
          $existing = Get-ADObject -SearchBase $schemaNc -LDAPFilter '(lDAPDisplayName=msLAPS-PasswordExpirationTime)' -ErrorAction SilentlyContinue
          if (-not $existing) {
            Update-LapsADSchema -Confirm:$false

            for ($i=0; $i -lt 30; $i++) {
              Start-Sleep -Seconds 2
              $existing = Get-ADObject -SearchBase $schemaNc -LDAPFilter '(lDAPDisplayName=msLAPS-PasswordExpirationTime)' -ErrorAction SilentlyContinue
              if ($existing) { break }
            }

            if (-not $existing) {
              throw "LAPS schema update did not create msLAPS-PasswordExpirationTime"
            }

            Write-Output 'laps_schema_updated'
          } else {
            Write-Output 'laps_schema_already_present'
          }
      register: laps_schema
      changed_when: "'laps_schema_updated' in (laps_schema.stdout | default(''))"
  rescue:
    - name: Rafraichir la connexion WinRM (token refresh apres echec LAPS)
      meta: reset_connection

    - name: Etendre le schema AD pour Windows LAPS (tentative 2)
      ansible.windows.win_shell:
        _raw_params: |
          $ErrorActionPreference = "Stop"
          Import-Module ActiveDirectory

          if (-not (Get-Command Update-LapsADSchema -ErrorAction SilentlyContinue)) {
            throw "Update-LapsADSchema introuvable (module Windows LAPS manquant ?)"
          }

          $schemaNc = (Get-ADRootDSE).schemaNamingContext
          $existing = Get-ADObject -SearchBase $schemaNc -LDAPFilter '(lDAPDisplayName=msLAPS-PasswordExpirationTime)' -ErrorAction SilentlyContinue
          if (-not $existing) {
            Update-LapsADSchema -Confirm:$false

            for ($i=0; $i -lt 30; $i++) {
              Start-Sleep -Seconds 2
              $existing = Get-ADObject -SearchBase $schemaNc -LDAPFilter '(lDAPDisplayName=msLAPS-PasswordExpirationTime)' -ErrorAction SilentlyContinue
              if ($existing) { break }
            }

            if (-not $existing) {
              throw "LAPS schema update did not create msLAPS-PasswordExpirationTime (retry)"
            }

            Write-Output 'laps_schema_updated_retry'
          } else {
            Write-Output 'laps_schema_already_present'
          }
      register: laps_schema_retry
      changed_when: "'laps_schema_updated_retry' in (laps_schema_retry.stdout | default(''))"

- name: Creer une OU dediee LAPS et deleguer les droits
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    $dn = ("{{ domain_name }}".Split('.') | ForEach-Object { "DC=$_" }) -join ','
    $ouName = "LAPS"
    $ou = Get-ADOrganizationalUnit -LDAPFilter "(ou=$ouName)" -SearchBase $dn -ErrorAction SilentlyContinue
    if (-not $ou) {
      New-ADOrganizationalUnit -Name $ouName -Path $dn -ProtectedFromAccidentalDeletion:$false -ErrorAction Stop | Out-Null
      $ou = Get-ADOrganizationalUnit -LDAPFilter "(ou=$ouName)" -SearchBase $dn -ErrorAction Stop
    }
    $ouDn = $ou.DistinguishedName
    if (-not $ouDn) { throw "OU DN is empty" }
    Set-LapsADComputerSelfPermission -Identity $ouDn
    Set-LapsADReadPasswordPermission -Identity $ouDn -AllowedPrincipals "Domain Admins"
    Set-LapsADResetPasswordPermission -Identity $ouDn -AllowedPrincipals "Domain Admins"
  changed_when: false

- name: Creer et lier une GPO LAPS (base)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    Import-Module GroupPolicy
    $gpoName = "MEGATP - LAPS"
    $domainDns = "{{ domain_name }}"
    $domainDn = ($domainDns.Split('.') | ForEach-Object { "DC=$_" }) -join ','
    $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
    if (-not $gpo) {
      $gpo = New-GPO -Name $gpoName
      Write-Output "gpo_created"
    }
    $links = (Get-GPInheritance -Target $domainDn).GpoLinks | Select-Object -ExpandProperty DisplayName
    if ($links -notcontains $gpoName) {
      New-GPLink -Name $gpoName -Target $domainDn | Out-Null
      Write-Output "gpo_linked"
    }
  register: gpo_base
  changed_when: "'gpo_created' in (gpo_base.stdout | default('')) or 'gpo_linked' in (gpo_base.stdout | default(''))"

- name: Attendre que SYSVOL/GPT soit pret pour la GPO LAPS
  ansible.windows.win_shell: |
    Import-Module GroupPolicy
    $gpoName = "MEGATP - LAPS"
    $domainDns = "{{ domain_name }}"
    $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
    if (-not $gpo) { exit 1 }
    $gpoGuid = $gpo.Id.ToString("B").ToUpper()
    $gptLocal = "C:\\Windows\\SYSVOL\\sysvol\\$domainDns\\Policies\\$gpoGuid"
    $gptUnc = "\\\\$domainDns\\SYSVOL\\$domainDns\\Policies\\$gpoGuid"
    if ((Test-Path -LiteralPath $gptLocal) -or (Test-Path -LiteralPath $gptUnc)) { exit 0 } else { exit 1 }
  register: gpo_sysvol_ready
  retries: 120
  delay: 5
  until: gpo_sysvol_ready.rc == 0
  changed_when: false

- name: Appliquer les parametres GPO LAPS (robuste)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    Import-Module GroupPolicy
    $gpoName = "MEGATP - LAPS"
    $key = "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\LAPS"

    function Get-GpValueSafe {
      param([string]$GpoName, [string]$Key, [string]$ValueName)
      try {
        return (Get-GPRegistryValue -Name $GpoName -Key $Key -ValueName $ValueName -ErrorAction Stop).Value
      } catch {
        return $null
      }
    }

    function Set-GpValueSafe {
      param([string]$GpoName, [string]$Key, [string]$ValueName, [string]$Type, [object]$Value)
      for ($try=1; $try -le 15; $try++) {
        try {
          Set-GPRegistryValue -Name $GpoName -Key $Key -ValueName $ValueName -Type $Type -Value $Value -ErrorAction Stop | Out-Null
          return $true
        } catch {
          Start-Sleep -Seconds 6
        }
      }
      throw "Failed to set GPO value $ValueName after retries"
    }

    $settings = @(
      @{ Name='BackupDirectory'; Type='DWord'; Value=2 },
      @{ Name='PasswordComplexity'; Type='DWord'; Value=4 },
      @{ Name='PasswordLength'; Type='DWord'; Value=14 },
      @{ Name='PasswordAgeDays'; Type='DWord'; Value=30 },
      @{ Name='AdministratorAccountName'; Type='String'; Value='Administrator' }
    )

    $changed = $false
    foreach ($s in $settings) {
      $current = Get-GpValueSafe -GpoName $gpoName -Key $key -ValueName $s.Name
      if ($null -eq $current -or $current -ne $s.Value) {
        Set-GpValueSafe -GpoName $gpoName -Key $key -ValueName $s.Name -Type $s.Type -Value $s.Value | Out-Null
        $changed = $true
      }
    }
    if ($changed) { Write-Output 'gpo_changed' }
  register: laps_gpo
  changed_when: "'gpo_changed' in (laps_gpo.stdout | default(''))"

- name: Politique mot de passe stricte (domaine)
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    $domain = "{{ domain_name }}"
    Set-ADDefaultDomainPasswordPolicy -Identity $domain `
      -MinPasswordLength 12 `
      -ComplexityEnabled $true `
      -PasswordHistoryCount 5 `
      -MaxPasswordAge (New-TimeSpan -Days 90) `
      -MinPasswordAge (New-TimeSpan -Days 1)
  changed_when: false

- name: Desactiver le compte Invite (Guest) du domaine
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    $guest = Get-ADUser -Filter "SamAccountName -eq 'Guest'" -ErrorAction SilentlyContinue
    if ($guest) { Disable-ADAccount -Identity $guest }
  changed_when: false

- name: Desactiver SMBv1 (serveur)
  ansible.windows.win_feature:
    name: FS-SMB1
    state: absent
  register: smb1_remove

- name: Redemarrer apres suppression SMBv1 (si necessaire)
  ansible.windows.win_reboot:
  when: smb1_remove.reboot_required | default(false)

- name: Desactiver LLMNR
  ansible.windows.win_shell: |
    $path = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient'
    if (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
    $current = (Get-ItemProperty -Path $path -Name EnableMulticast -ErrorAction SilentlyContinue).EnableMulticast
    if ($null -eq $current -or $current -ne 0) {
      New-ItemProperty -Path $path -Name EnableMulticast -PropertyType DWord -Value 0 -Force | Out-Null
      Write-Output 'llmnr_disabled'
    } else {
      Write-Output 'llmnr_already_disabled'
    }
  register: llmnr_result
  changed_when: "'llmnr_disabled' in (llmnr_result.stdout | default(''))"

- name: Activer les profils de pare-feu Domain/Private/Public
  ansible.windows.win_shell: Set-NetFirewallProfile -Profile Domain,Private,Public -Enabled True
  changed_when: false
